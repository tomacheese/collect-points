# CLAUDE.md

## 目的

このファイルは、Claude Code の作業方針とプロジェクト固有のルールを示します。

## 判断記録のルール

1. 判断内容の要約を記載する
2. 検討した代替案を列挙する
3. 採用しなかった案とその理由を明記する
4. 前提条件・仮定・不確実性を明示する
5. 他エージェントによるレビュー可否を示す

## プロジェクト概要

Puppeteer を使用してポイントサイト（PointTown、ECNavi）のポイント収集を自動化するプロジェクト。
**目的はポイントを「収集」することであり、実際にポイントが獲得できるインタラクションの実装が必須です。**

## 重要ルール

- **会話言語**: 日本語
- **コミット規約**: Conventional Commits（`<description>` は日本語）
- **コメント言語**: 日本語
- **エラーメッセージ**: 英語（既存のメッセージに絵文字がある場合は、全体で統一して絵文字を設定）

## 環境のルール

- **ブランチ命名**: Conventional Branch（`<type>` は feat, fix 等の短縮形）
- **リポジトリ調査**: GitHub リポジトリを調査する際は、テンポラリディレクトリにクローンして検索する
- **Renovate**: Renovate が作成した PR に対して追加コミットを行わない

## Git Worktree

Git Worktree を採用している場合、ディレクトリ構成は以下とする：

- `.bare/` (bare リポジトリ)
- `<branch>/` (各ブランチの worktree)

## コード改修時のルール

- 日本語と英数字の間には半角スペースを挿入する
- TypeScript の `skipLibCheck` を有効にして型エラーを回避しない
- 関数やインターフェースには日本語で docstring を記載する

## 相談ルール

- **Codex CLI**: 実装レビュー、局所設計、既存コードとの整合性確認に使用
- **Gemini CLI**: 外部仕様の調査、最新情報の確認、マニュアル等の検索に使用
- **指摘への対応**: コードレビュー等の指摘に対しては、信頼度スコア 50 以上のものには必ず対応する（黙殺禁止）

## 開発コマンド

```bash
pnpm install  # 依存関係インストール
pnpm start    # 実行
pnpm dev      # 開発実行 (watch)
pnpm run lint # Lint チェック
pnpm run fix  # 自動修正
```

## アーキテクチャと主要ファイル

- `src/core/`: コア機能（基底クラス、設定、通知）
- `src/providers/`: 各ポイントサイトの実装（ECNavi, PointTown）
- `src/utils/`: 共通ユーティリティ
- `src/main.ts`: エントリーポイント

## 実装パターン

### パターン 1: 広告視聴型

広告視聴後にポイント/スタンプが獲得できるもの。適切な待機（約 30 秒）が必要。

### パターン 2: クイズ/回答型

クイズに回答してポイントを獲得するもの。ランダムな回答選択でも参加ポイントが得られることが多い。

### パターン 3: スタンプ収集型

訪問や特定のアクションでスタンプを集めるもの。

## テスト

- 自動テストはないため、実際に動作させてポイントの増減を確認する
- ログ出力を確認し、エラーが発生していないか検証する

## ドキュメント更新ルール

- 技術スタック、開発コマンド、プロジェクト要件の変更時に、本ファイルを含むプロンプトファイルを更新する

## 作業チェックリスト

### 新規改修時

1. プロジェクトを理解する
2. 適切なブランチ（最新のリモートに基づく）で作業する
3. 依存パッケージをインストールする

### コミット・プッシュ前

1. Conventional Commits に従っているか確認
2. センシティブな情報が含まれていないか確認
3. Lint / Format エラーがないか確認
4. 動作確認を行う

### PR 作成前

1. PR 作成の依頼があるか確認
2. コンフリクトの恐れがないか確認

### PR 作成後

1. コンフリクトがないか確認
2. PR 本文が最新の状態を日本語で網羅しているか確認
3. CI（GitHub Actions）の成功を確認
4. コードレビューの指摘に対応する

## リポジトリ固有の注意事項

- **Puppeteer 構成**: `rebrowser-puppeteer-core` を使用している。
- **ボット対策**: 適度な `sleep` を挿入し、ボット検知を回避する。
- **セレクター**: `:has-text()` は Puppeteer で動作しないため使用しない。
- **自動運用**: 毎週・毎日の自動スクリプト（`scripts/`）による Issue 作成・エラー調査が行われている。
